<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Role - Tikkit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    :root { user-select: none; }
    body { background-color: #f5f5f5; font-size: 12px; }
    .section-header {
      display: flex; justify-content: space-between; align-items: center;
      background: #f0f0f0; padding: 6px 12px; border: 1px solid #dee2e6;
      border-radius: 5px; font-weight: bold; font-size: 13px; margin: 10px 0;
    }
    .container { display: flex; gap: 10px; margin-top: 10px; }
    .left-pane {
      flex: 1; background: white; padding: 15px; border: 1px solid #ddd;
      border-radius: 5px; min-width: 420px; max-width: 500px;
      height: calc(100vh - 110px); overflow-y: auto;
    }
    .right-pane {
      flex: 2.5; background: white; padding: 15px; border: 1px solid #ddd;
      border-radius: 5px; height: calc(100vh - 110px);
      display: flex; flex-direction: column;
    }
    .table-section { flex-grow: 1; display: flex; flex-direction: column; }
    .table-responsive { flex-grow: 1; overflow: auto; }
    .form-control, .form-select { font-size: 12px; height: 30px; padding: 4px 8px; }
    .form-label { font-size: 12px; margin-bottom: 4px; font-weight: 500; }
    .mandatory::after { content: "*"; color: red; margin-left: 2px; }
    .btn-sm { padding: 4px 10px; font-size: 12px; }
    .footer {
      position: fixed; bottom: 0; left: 0; width: 100%;
      font-size: 11px; user-select: none; box-shadow: 0 -1px 4px rgba(0,0,0,0.05);
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom px-3">
  <a class="navbar-brand d-flex align-items-center" href="#">
    <img src="https://via.placeholder.com/40x30?text=Logo" alt="Logo" />
    <span>Tikkit</span>
  </a>
  <ul class="navbar-nav me-auto mb-2 mb-lg-0 align-items-center">
    <li class="nav-item">
      <a class="nav-link btn btn-outline-primary btn-sm px-3 ms-2" href="#">Home</a>
    </li>
    <li class="nav-item ms-3">
      <input type="text" class="form-control search-input" placeholder="Search Role..." />
    </li>
  </ul>
</nav>

<div class="container">
  <!-- Left Pane (Form) -->
  <form id="roleForm" class="needs-validation" novalidate>
    <div class="left-pane">
      <div class="section-header">
        <div>Role</div>
        <div class="d-flex gap-2">
          <button type="submit" id="btnSave" class="btn btn-success btn-sm flex-grow-1">Save</button>
          <button type="button" id="btnUpdate" class="btn btn-primary btn-sm flex-grow-1" style="display:none;">Update</button>
          <button type="button" onclick="resetForm()" class="btn btn-secondary btn-sm flex-grow-1">Clear</button>
        </div>
      </div>

      <div class="mb-2">
        <label for="roleName" class="form-label mandatory">Role Name</label>
        <input type="text" class="form-control form-control-sm" id="roleName" name="roleName" required />
      </div>

      <div class="mb-3">
        <label for="isActive" class="form-check-label me-2">
          <input type="checkbox" class="form-check-input" id="isActive" name="isActive" checked />
          Active
        </label>
      </div>

      <input type="hidden" id="roleId" name="roleId" />

      <div class="d-flex justify-content-end align-items-center">
        <span class="text-danger me-2">* Indicates Mandatory Fields</span>
      </div>
    </div>
  </form>

  <!-- Right Pane (List) -->
  <div class="right-pane">
    <div class="table-section">
      <div class="section-header">
        <div>Role List</div>
        <div><button id="btnGetData" class="btn btn-sm btn-primary">Get Data</button></div>
      </div>

      <div class="p-2 border-bottom bg-light">
        <div class="row g-2">
          <div class="col">
            <input type="text" id="searchRoleName" class="form-control form-control-sm" placeholder="Search Role Name" />
          </div>
          <div class="col">
            <input type="text" id="searchIsActive" class="form-control form-control-sm" placeholder="Search Active (A/I)" />
          </div>
        </div>
      </div>

      <div class="table-responsive flex-grow-1">
        <table class="table table-bordered table-striped table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Role Name</th>
              <th>Status</th>
              <th>Created</th>
              <th>Modified</th>
              <th style="width: 120px;">Manipulation</th>
            </tr>
          </thead>
          <tbody id="roleTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<footer class="footer bg-white border-top text-center p-1">
  Tikkit - Role - v1.0.0 - Â©2023
</footer>

<!-- ========================= SCRIPT SECTION ========================= -->
<script>
  const form = document.getElementById('roleForm');
  const tbody = document.getElementById('roleTableBody');
  let roles = [];

  // Save / Create
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!form.checkValidity()) {
      form.classList.add('was-validated');
      return;
    }

    const data = getFormData();
    try {
      const res = await fetch('/api/roles', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (!res.ok) throw new Error('Failed to save role');
      alert('Role saved successfully');
      resetForm();
      fetchRoles();
    } catch (err) {
      alert(err.message);
    }
  });

  function getFormData() {
    const rawId = parseInt(form.dataset.roleId || '0');
    const isNew = isNaN(rawId) || rawId <= 0;
    const data = {
      roleName: form.roleName.value.trim(),
      isActive: form.isActive.checked
    };
    if (!isNew) data.roleId = rawId;
    return data;
  }

  function resetForm() {
    form.reset();
    form.dataset.roleId = null;
    form.classList.remove('was-validated');
    form.isActive.checked = true;
    document.getElementById('btnSave').style.display = 'inline-block';
    document.getElementById('btnUpdate').style.display = 'none';
  }

  // Fetch roles
  async function fetchRoles() {
    const searchParams = new URLSearchParams();
    const name = document.getElementById('searchRoleName').value.trim();
    const activeVal = document.getElementById('searchIsActive').value.trim().toUpperCase();

    if (name) searchParams.append('roleName', name);
    if (activeVal === 'A') searchParams.append('isActive', 'true');
    else if (activeVal === 'I') searchParams.append('isActive', 'false');

    try {
      const res = await fetch('/api/roles?' + searchParams.toString());
      if (!res.ok) throw new Error('Failed to fetch roles');
      roles = await res.json();
      renderRoles();
    } catch (err) {
      alert(err.message);
    }
  }

  function renderRoles() {
    tbody.innerHTML = '';
    if (!Array.isArray(roles)) return;

    roles.forEach(role => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${role.roleId}</td>
        <td>${role.roleName}</td>
        <td>${role.isActive ? 'Active' : 'Inactive'}</td>
        <td>${role.createdDt ? role.createdDt.replace('T', ' ') : ''}</td>
        <td>${role.modifiedDt ? role.modifiedDt.replace('T', ' ') : ''}</td>
        <td>
          <button class="btn btn-sm btn-info btn-action" onclick="editRole(${role.roleId})">E</button>
          <button class="btn btn-sm btn-warning btn-action" onclick="toggleActive(${role.roleId}, ${role.isActive})">${role.isActive ? 'I' : 'A'}</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  async function editRole(id) {
    try {
      const res = await fetch(`/api/roles/${id}`);
      if (!res.ok) throw new Error('Role not found');
      const role = await res.json();

      form.dataset.roleId = role.roleId;
      form.roleName.value = role.roleName || '';
      form.isActive.checked = role.isActive;
      form.classList.remove('was-validated');

      document.getElementById('btnSave').style.display = 'none';
      document.getElementById('btnUpdate').style.display = 'inline-block';
    } catch (err) {
      alert(err.message);
    }
  }

  document.getElementById('btnUpdate').addEventListener('click', updateRole);
  async function updateRole() {
    if (!form.checkValidity()) {
      form.classList.add('was-validated');
      return;
    }

    const data = getFormData();
    const roleId = parseInt(form.dataset.roleId || 0);
    if (!roleId) {
      alert("Invalid role ID for update.");
      return;
    }

    try {
      const res = await fetch(`/api/roles/${roleId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (!res.ok) throw new Error('Failed to update role');
      alert('Role updated successfully');
      resetForm();
      fetchRoles();
    } catch (err) {
      alert(err.message);
    }
  }

  async function toggleActive(id, currentStatus) {
    if (!confirm(`Are you sure you want to ${currentStatus ? 'deactivate' : 'activate'} this role?`)) return;
    try {
      const resGet = await fetch(`/api/roles/${id}`);
      if (!resGet.ok) throw new Error('Role not found');
      const role = await resGet.json();
      role.isActive = !currentStatus;

      const resPut = await fetch(`/api/roles/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(role)
      });

      if (!resPut.ok) throw new Error('Failed to update role status');
      alert(`Role ${role.isActive ? 'activated' : 'deactivated'} successfully`);
      fetchRoles();
    } catch (err) {
      alert(err.message);
    }
  }

  document.getElementById('btnGetData').addEventListener('click', fetchRoles);
  fetchRoles();
  resetForm();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
